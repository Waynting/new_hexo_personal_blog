# 📸 如何使用本地圖片自動處理功能

## 🎯 功能說明

這個功能讓你在寫作時可以直接使用本地電腦中的圖片路徑，build 時會自動：

1. ✅ 轉換為 WebP 格式並壓縮
2. ✅ 上傳到 Cloudflare R2
3. ✅ 替換 MDX 中的路徑為 CDN URL
4. ✅ 自動創建對應的年月資料夾

---

## 📝 使用方式

### 方法 1：使用 `file://` 協議（推薦）

在文章中直接使用本地圖片的絕對路徑：

```markdown
---
title: "我的新文章"
date: 2025-01-15
slug: "my-new-post"
coverImage: "file:///Users/waynliu/Pictures/cover.jpg"
---

# 文章內容

![美麗的風景](file:///Users/waynliu/Pictures/2025/01/photo1.jpg)
![另一張圖](file:///Users/waynliu/Pictures/2025/01/photo2.png)
```

### 方法 2：使用絕對路徑

也可以直接使用絕對路徑（不需要 `file://` 前綴）：

```markdown
![圖片說明](/Users/waynliu/Pictures/image.jpg)
```

### 方法 3：拖放圖片（macOS）

在 macOS 中，你可以：

1. 按住 **Option** 鍵
2. 拖放圖片到編輯器
3. 會自動插入絕對路徑

---

## 🚀 執行處理

### 自動處理（Build 時）

```bash
npm run build
# 會自動執行 prebuild 腳本，處理所有本地圖片
```

### 手動處理（推薦先測試）

```bash
npm run images:process
```

**建議工作流程：**

```bash
# 1. 寫完文章後，先手動處理圖片
npm run images:process

# 2. 檢查處理結果，確認無誤

# 3. 本地預覽
npm run dev

# 4. Build 部署
npm run build
```

---

## 📊 處理過程說明

### 1. 掃描階段

腳本會掃描所有 `content/**/*.mdx` 檔案，尋找：

- Markdown 圖片語法：`![](路徑)`
- Frontmatter 中的 `coverImage`
- 支援 `file://` 和絕對路徑

### 2. 轉換階段

對每張圖片：

- 讀取本地檔案
- 使用 Sharp 轉換為 WebP 格式
- 智能壓縮：
  - 檔案 > 2MB：品質 75%
  - 檔案 ≤ 2MB：品質 85%
- 限制最大寬度 2000px（保持比例）

### 3. 上傳階段

上傳到 R2：

```
路徑格式：{year}/{month}/{slug}/{filename}.webp

範例：
原始：file:///Users/waynliu/Pictures/photo.jpg
R2：  2025/01/my-post/photo.webp
URL： https://img.waynspace.com/2025/01/my-post/photo.webp
```

### 4. 替換階段

自動更新 MDX 檔案：

```markdown
# 原始
![風景](file:///Users/waynliu/Pictures/photo.jpg)

# 處理後
![風景](https://img.waynspace.com/2025/01/my-post/photo.webp)
```

---

## 🎨 完整範例

### 寫作時

```markdown
---
title: "2025 台北街拍"
date: 2025-01-15
slug: "taipei-street-photography-2025"
coverImage: "file:///Users/waynliu/Pictures/2025/01/taipei-cover.jpg"
categories:
  - 攝影筆記
tags:
  - 街拍
  - 台北
---

# 2025 台北街拍

今天在台北街頭拍攝了一些有趣的畫面。

![西門町街景](file:///Users/waynliu/Pictures/2025/01/ximending-01.jpg)

這張照片拍攝於西門町...

![信義區夜景](file:///Users/waynliu/Pictures/2025/01/xinyi-night.png)

晚上的信義區特別美...
```

### 執行處理

```bash
$ npm run images:process

🚀 開始處理本地圖片...

📋 配置：
   內容目錄: /Users/waynliu/Documents/GitHub/new_hexo_personal_blog/content
   R2 Bucket: blog-post
   CDN URL: https://img.waynspace.com
   快取目錄: /Users/waynliu/Documents/GitHub/new_hexo_personal_blog/.image-cache

找到 1 個 MDX 檔案

📝 處理文章: 2025/01/taipei-street-photography-2025
  找到 3 張本地圖片
  🖼️  處理封面圖...
  📸 處理中: taipei-cover.jpg → taipei-cover.webp
  ✅ 已上傳: 2025/01/taipei-street-photography-2025/taipei-cover.webp
     原始大小: 3245.6 KB
     壓縮後: 892.3 KB (節省 72.5%)
  📸 處理中: ximending-01.jpg → ximending-01.webp
  ✅ 已上傳: 2025/01/taipei-street-photography-2025/ximending-01.webp
     原始大小: 2156.8 KB
     壓縮後: 623.1 KB (節省 71.1%)
  📸 處理中: xinyi-night.png → xinyi-night.webp
  ✅ 已上傳: 2025/01/taipei-street-photography-2025/xinyi-night.webp
     原始大小: 4567.2 KB
     壓縮後: 1123.5 KB (節省 75.4%)
  💾 已更新 MDX 檔案

============================================================
✨ 處理完成！

📊 統計資訊：
   處理檔案: 1 個
   處理圖片: 3 張
   跳過圖片: 0 張
   錯誤數量: 0 個

💾 檔案大小：
   原始總大小: 9.69 MB
   壓縮後大小: 2.64 MB
   節省空間: 72.8%

============================================================
```

### 處理後的 MDX

```markdown
---
title: "2025 台北街拍"
date: 2025-01-15
slug: "taipei-street-photography-2025"
coverImage: "https://img.waynspace.com/2025/01/taipei-street-photography-2025/taipei-cover.webp"
categories:
  - 攝影筆記
tags:
  - 街拍
  - 台北
---

# 2025 台北街拍

今天在台北街頭拍攝了一些有趣的畫面。

![西門町街景](https://img.waynspace.com/2025/01/taipei-street-photography-2025/ximending-01.webp)

這張照片拍攝於西門町...

![信義區夜景](https://img.waynspace.com/2025/01/taipei-street-photography-2025/xinyi-night.webp)

晚上的信義區特別美...
```

---

## 🔄 快取機制

### 智能快取

腳本會使用 MD5 hash 來檢查圖片是否已處理過：

```
.image-cache/
└── a3f5e9c2b1d4f6e8.json
    {
      "cdnUrl": "https://img.waynspace.com/2025/01/my-post/photo.webp",
      "r2Key": "2025/01/my-post/photo.webp",
      "originalSize": 2048576,
      "compressedSize": 512000
    }
```

**優點：**

- ✅ 相同圖片不會重複處理
- ✅ 加快處理速度
- ✅ 節省 R2 上傳流量

### 清除快取

如果需要重新處理所有圖片：

```bash
rm -rf .image-cache
npm run images:process
```

---

## ⚠️ 注意事項

### 1. 檔案路徑格式

```markdown
✅ 正確：file:///Users/waynliu/Pictures/photo.jpg
✅ 正確：/Users/waynliu/Pictures/photo.jpg
❌ 錯誤：~/Pictures/photo.jpg （不支援 ~ 符號）
❌ 錯誤：./images/photo.jpg （相對路徑會被保留，不會處理）
```

### 2. 支援的圖片格式

- ✅ JPG / JPEG
- ✅ PNG
- ✅ GIF
- ✅ WebP
- ✅ AVIF
- ✅ TIFF

### 3. 檔案必須存在

如果本地檔案不存在，會跳過該圖片並顯示警告：

```
⚠️  檔案不存在，跳過: /Users/waynliu/Pictures/missing.jpg
```

### 4. Build 失敗處理

如果圖片處理失敗，build 會中斷：

```bash
❌ 發生嚴重錯誤： Error: ...
```

解決方式：

1. 檢查錯誤訊息
2. 修正問題後重新執行
3. 或暫時移除 `prebuild` 腳本，手動處理圖片

---

## 🛠️ 環境變數設定

確保 `.env` 檔案包含：

```env
# Cloudflare R2 配置
CF_ACCOUNT_ID=你的帳號ID
R2_ACCESS_KEY_ID=你的AccessKey
R2_SECRET_ACCESS_KEY=你的SecretKey
R2_BUCKET=blog-post
R2_BASE_URL=https://img.waynspace.com
```

### 如何獲取 R2 Credentials

1. 前往 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 選擇 **R2** > **Overview**
3. 點擊 **Manage R2 API Tokens**
4. 建立新的 API Token（權限：Read & Write）
5. 複製 Access Key ID 和 Secret Access Key

---

## 🎯 最佳實踐

### 推薦工作流程

```bash
# 1. 寫文章時直接使用本地圖片路徑
# 使用 Option + 拖放，或手動輸入 file:// 路徑

# 2. 寫完後，手動處理一次圖片（檢查結果）
npm run images:process

# 3. 本地預覽，確認圖片正確顯示
npm run dev

# 4. 提交到 Git
git add .
git commit -m "新增文章：xxx"
git push

# 5. 部署時會自動處理（prebuild）
npm run build
```

### 圖片命名建議

```bash
# ✅ 好的命名（有意義、容易識別）
taipei-night-view-2025-01-15.jpg
product-screenshot-login-page.png
portrait-john-smith.jpg

# ❌ 不好的命名（難以管理）
IMG_1234.jpg
Screenshot 2025-01-15 at 10.30.45.png
未命名.png
```

### 圖片整理建議

建議在本地電腦建立結構化的圖片資料夾：

```
~/Pictures/Blog/
├── 2025/
│   ├── 01/
│   │   ├── taipei-street/
│   │   │   ├── cover.jpg
│   │   │   ├── photo-01.jpg
│   │   │   └── photo-02.jpg
│   │   └── product-launch/
│   │       ├── cover.png
│   │       └── screenshot.png
│   └── 02/
└── 2024/
```

---

## 🐛 常見問題

### Q1: 執行時出現「缺少必要的環境變數」錯誤

**A:** 檢查 `.env` 檔案是否包含所有必要的 R2 配置，參考[環境變數設定](#🛠️-環境變數設定)章節。

### Q2: 圖片處理後，檔案大小反而變大了？

**A:** WebP 格式對於某些類型的圖片（如線條圖、截圖）可能壓縮效果不佳。建議手動調整品質設定。

### Q3: 處理速度很慢怎麼辦？

**A:** 腳本已內建並行處理（最多 3 張同時處理），如果仍然很慢：
- 檢查網路速度（上傳到 R2）
- 檢查圖片大小（建議先在本地壓縮）
- 使用快取機制（相同圖片不會重複處理）

### Q4: 我想保留本地圖片路徑（不想自動處理）怎麼辦？

**A:** 使用相對路徑即可，腳本只會處理 `file://` 和絕對路徑：

```markdown
# 不會被處理（相對路徑）
![](./images/local.jpg)

# 會被處理（絕對路徑）
![](file:///Users/waynliu/Pictures/photo.jpg)
```

### Q5: Build 時可以跳過圖片處理嗎？

**A:** 可以，有兩種方式：

```bash
# 方式 1：跳過 prebuild（臨時）
npm run build --ignore-scripts

# 方式 2：移除 package.json 中的 prebuild（永久）
# 刪除或註解掉這一行：
# "prebuild": "node scripts/process-local-images.mjs",
```

---

## 📚 相關文件

- [如何撰寫文章.md](如何撰寫文章.md) - 文章撰寫完整指南
- [README.md](README.md) - 專案說明文件
- [Cloudflare R2 文件](https://developers.cloudflare.com/r2/)
- [Sharp 文件](https://sharp.pixelplumbing.com/)

---

**最後更新日期：2025-01-15**
